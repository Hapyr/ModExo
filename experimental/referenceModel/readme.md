### Parameter Estimation

The controller implements a simple integration algorithm which calculates the output position of the joint according to the given torque input. The relation between torque and position is defined by the second order equation:

	tau = J*X3 + b*X2 + k*X1

Where X1, X2 and X3 are, respectively, angular position, angular velocity and angular acceleration. Although J, b and k could have a physical correspondence to Inertia, Dumping and Stiffness, because the process is discrete, they have no physical meaning and can be simply assumed as coefficients multiplying those variables. For that reason, those variables will be referred as the vector Ad = [ad0, ad1, ad2] = [J, b, k]. Below are described the steps to find constants that will adjust J, b and k to the international standard. 

Our goal is to estimate a vector Aec to find a vector W = [w0 w1 w2] such as Ad/Aec = W. After that, Ad/W = Adc should represent parameters in continuous time equal to those defined in Ad.

#### Model Reference Tracking

As already mentioned in the control structure, the High Level Controller calculates the reference model position for a given input. The Low Level Controller task is to make the joint position as close as possible to that virtual position. In figures 1 and 2, it is possible to observe the tracking performance for the joint with no extra mass.

![Model Reference Tracking](https://biopmr.github.io/images/modelReferenceTracking.png)

![Model Reference Tracking 2](https://biopmr.github.io/images/modelReferenceTracking1.png)

The figures show two plots, \theta_m refers to the Model Reference Position calculated by the Arduino when submitted by a 50mNm torque input. \theta_e refers to the joint position given by the MILE Encoder in the motor. It is possible to observe that the curves are really close. Further experiments are required with higher impedance attached to the joint, however, for the analysis that will follow, we will consider that there is no significative difference in between the virtual dynamics requested by the Reference Model and the apparent dynamics performed by the Plant.

For these curves, the parameters set to the Arduino are Ad = [0.05, 1, 10]

#### Transfer Function Estimation

In order to obtain the estimation vector Aec, we will be looking at the position generated by the Arduino from the previous section and, with the MATLAB function _tfest_, estimating a transfer function which reproduces that response. From the transfer function, the state spaces representation in obtained, which contains the parameters Aec in the form:

A = [-b/J -k/J ; 1 0 ];



![Model Reference Response to Torque input of 50mNm](https://biopmr.github.io/images/modelReferenceTracking2.png)
	
	Model Reference Response to Torque input of 50mNm
	Estimated using TFEST on time domain data "dataArduino".
	dataArduino = iddata(X1*qc_to_rad*10000,LoadCell,'Ts', 50)
	Fit to estimation data: 99.91%                          	
	Ad = [0.05, 1, 10]
	Amd = [-20, -200 ; 1, 0]
	Aec = [-0.0020, -2.1035e-06 ; 1, 0]
	Amd(1,1)/Amd(1,2) = 0.1
	Aec(1,1)/Aec(1,2) = 949.4914

![Model Reference Response to Torque input of 50mNm](https://biopmr.github.io/images/modelReferenceTracking3.png)	

	Model Reference Response to Torque input of 50mNm
	Estimated using TFEST on time domain data "dataArduino".
	dataArduino = iddata(X1*qc_to_rad*10000,LoadCell,'Ts', 50)
	Fit to estimation data: 88.51%                          
	Ad = [0.05, 1, 20]
	Amd = [-20, -400 ; 1, 0]
	Aec = [-0.0026 -3.6634e-06 ; 1, 0]
	Amd(1,1)/Amd(1,2) = 0.05
	Aec(1,1)/Aec(1,2) = 704.0654

![Model Reference Response to Torque input of 50mNm](https://biopmr.github.io/images/modelReferenceTracking4.png)

	Model Reference Response to Torque input of 50mNm
	Estimated using TFEST on time domain data "dataArduino".
	dataArduino = iddata(X1*qc_to_rad*10000,LoadCell,'Ts', 50)
	Fit to estimation data: 73.26%                          
	Ad = [0.05, 1, 2]
	Amd = [-20, -40 ; 1, 0]
	Aec = [-0.0071 -2.9713e-06 ; 1, 0]
	Amd(1,1)/Amd(1,2) = 0.5
	Aec(1,1)/Aec(1,2) = 2.378,4

![Model Reference Response to Torque input of 50mNm](https://biopmr.github.io/images/modelReferenceTracking5.png)

	Model Reference Response to Torque input of 50mNm
	Estimated using TFEST on time domain data "dataArduino".
	dataArduino = iddata(X1(1:835)*qc_to_rad*10000,LoadCell,'Ts', 50)
	Fit to estimation data: 99.97%                           
	Ad = [0.05, 1, 2]
	Amd = [-20, -40 ; 1, 0]
	Aec = [-0.0021 -4.2132e-07 ; 1, 0]
	Amd(1,1)/Amd(1,2) = 0.5
	Aec(1,1)/Aec(1,2) = 4949.3

![Model Reference Response to Torque input of 50mNm](https://biopmr.github.io/images/modelReferenceTracking6.png)

	Model Reference Response to Torque input of 50mNm
	Estimated using TFEST on time domain data "dataArduino".
	dataArduino = iddata(X1(1:327)*qc_to_rad*10000,LoadCell,'Ts', 50)
	Fit to estimation data: 99.84%                          
	Ad = [0.05, 1, 20]
	Amd = [-20, -400 ; 1, 0]
	Aec = [-0.0019, -4.1947e-06 ; 1, 0]
	Amd(1,1)/Amd(1,2) = 0.05
	Aec(1,1)/Aec(1,2) = 449.8469

![Model Reference Response to Torque input of 50mNm](https://biopmr.github.io/images/modelReferenceTracking7.png)

	Model Reference Response to Torque input of 100mNm
	Estimated using TFEST on time domain data "dataArduino".
	dataArduino = iddata(X1*qc_to_rad*10000,LoadCell,'Ts', 50)
	Fit to estimation data: 99.95%                          
	FPE: 4.183e-07, MSE: 4.169e-07  
	Ad = [0.05, 1, 10]
	Amd = [-20, -200 ; 1, 0]
	Aec = [-0.0020, -2.1025e-06 ; 1, 0]
	Amd(1,1)/Amd(1,2) = 0.1
	Aec(1,1)/Aec(1,2) = 949.5805

![Model Reference Response to Torque input of 50mNm](https://biopmr.github.io/images/modelReferenceTracking8.png)

	Model Reference Response to Torque input of 50mNm
	Estimated using TFEST on time domain data "dataArduino".
	dataArduino = iddata(X1(1:3984)*qc_to_rad*10000,LoadCell,'Ts', 50)
	Fit to estimation data: 99.95%                          
	FPE: 8.129e-07, MSE: 8.109e-07 
	Ad = [0.05, 5, 2]
	Amd = [-100, -40 ; 1, 0]
	Aec = [-0.1010, -4.0569e-06 ; 1, 0]
	Amd(1,1)/Amd(1,2) = 2.5
	Aec(1,1)/Aec(1,2) = 24885

![Model Reference Response to Torque input of 50mNm](https://biopmr.github.io/images/modelReferenceTracking9.png)

	Model Reference Response to Torque input of 50mNm
	Estimated using TFEST on time domain data "dataArduino".
	dataArduino = iddata(X1(1:469)*qc_to_rad*10000,LoadCell,'Ts', 50)
	Fit to estimation data: 99.75%                          
	FPE: 7.586e-07, MSE: 7.49e-07 
	Ad = [0.05, 5, 20]
	Amd = [-100, -400 ; 1, 0]
	Aec = [-0.0581, -2.4293e-05 ; 1, 0]
	Amd(1,1)/Amd(1,2) = 0.25
	Aec(1,1)/Aec(1,2) = 2391.7

#### Discussion

It is possible to observe from the data that the inertia is constant during all the tests. We will define two types of the model behaviour considering the ratio between the parameters corresponding to dumping and inertia, therefore, one where b/k > 1 and the other where b/k < 1. G and H are matrices containing the model's parameters, their ratio, the estimated parameters and their ratio.
We will not use the data with less than 99% of fit to estimation.

![Model Reference Response to Torque input of 50mNm](https://biopmr.github.io/images/ratios.png)
	Ratios of ratios
	This figures shows the ration between the model ratios and the estimated ratios. Can we consider that curve constant? Can we find a constant that relates estimated parameters and modelled parameters?

#### Variables Definition

Ad: Parameters set to Arduino
Amd: The model's A matrix in discrete time
Aec: The estimated A matrix in continuous time



